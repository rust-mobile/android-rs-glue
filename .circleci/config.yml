version: 2

jobs:

  build-base-image:
    working_directory: ~/android-rs-glue
    docker:
      - image: ubuntu:xenial
    steps:
      - run:
          name: Install dependencies
          command: |
            apt-get update
            apt-get install -yq curl
      - run:
          name: Install Docker client
          command: |
            set -x
            VER="17.03.0-ce"
            curl -L -o /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz
            tar -xz -C /tmp -f /tmp/docker-$VER.tgz
            mv /tmp/docker/* /usr/bin
      - setup_remote_docker
      - run:
          name: Build base image
          command: |
            docker build -t tomaka/rust-android -f .circleci/base.docker .
      - run:
          name: Publish base image
          command: |
            docker login -u $DOCKERHUB_LOGIN -p $DOCKERHUB_PASSWORD
            docker push tomaka/rust-android

  test:
    working_directory: ~/android-rs-glue
    docker:
      - image: tomaka/rust-android
    steps:
      - run:
          name: Install dependencies
          command: |
            apt-get update
            apt-get install -yq sudo curl file build-essential wget git g++ cmake pkg-config bison flex unzip ant openjdk-8-jdk lib32stdc++6 lib32z1 docker
            curl https://sh.rustup.rs -s > /home/install.sh
            chmod +x /home/install.sh
            sh /home/install.sh -y --verbose --default-toolchain nightly
            export PATH="/root/.cargo/bin:$PATH"
      - checkout
      - run: cargo build --verbose --manifest-path glue/Cargo.toml
      - run: cargo build --verbose --manifest-path cargo-apk/Cargo.toml
      - setup_remote_docker
      - run: docker build -t cargo-apk .
      - run: docker run --rm -v `pwd`:/root/src -w /root/src/examples/basic cargo-apk cargo apk
      - run: docker run --rm -v `pwd`:/root/src -w /root/src/examples/use_assets cargo-apk cargo apk
      - run: docker run --rm -v `pwd`:/root/src -w /root/src/examples/use_icon cargo-apk cargo apk

workflows:
  version: 2
  all:
    jobs:
      - build-base-image
      #- test
